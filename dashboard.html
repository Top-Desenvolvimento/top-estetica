<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Top Est√©tica Bucal ‚Äî PIX Doutores</title>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;600;700&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0a0e1a; --surface: #111827; --surface2: #1a2235; --border: #1e2d45;
    --accent: #00d4ff; --accent2: #00ff9d; --danger: #ff3b5c; --warning: #ffb547;
    --text: #e8f0fe; --muted: #6b7fa3; --card-radius: 16px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: var(--bg); color: var(--text); font-family: 'Sora', sans-serif; min-height: 100vh; overflow-x: hidden; }
  body::before {
    content: ''; position: fixed; top: -50%; left: -50%; width: 200%; height: 200%;
    background: radial-gradient(ellipse at 20% 20%, rgba(0,212,255,0.05) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(0,255,157,0.04) 0%, transparent 50%);
    pointer-events: none; z-index: 0;
  }

  /* HEADER */
  header {
    position: sticky; top: 0; z-index: 100;
    background: rgba(10,14,26,0.95); backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border);
    padding: 0 2rem; display: flex; align-items: center; justify-content: space-between; height: 64px;
  }
  .logo { display: flex; align-items: center; gap: 12px; }
  .logo-icon { width: 36px; height: 36px; background: linear-gradient(135deg, var(--accent), var(--accent2)); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; }
  .logo-text { font-size: 1rem; font-weight: 700; }
  .logo-sub { font-size: 0.7rem; color: var(--muted); font-weight: 300; }
  .header-right { display: flex; align-items: center; gap: 10px; }
  #last-update { font-size: 0.72rem; color: var(--muted); font-family: 'JetBrains Mono', monospace; }

  /* TABS */
  .tabs { display: flex; gap: 4px; background: var(--surface2); border-radius: 10px; padding: 4px; }
  .tab-btn {
    padding: 6px 16px; border-radius: 7px; border: none; cursor: pointer;
    font-family: 'Sora', sans-serif; font-size: 0.8rem; font-weight: 600;
    background: transparent; color: var(--muted); transition: all 0.2s;
  }
  .tab-btn.active { background: var(--surface); color: var(--text); box-shadow: 0 2px 8px rgba(0,0,0,0.3); }

  .btn {
    display: flex; align-items: center; gap: 6px; padding: 8px 16px;
    border-radius: 8px; border: none; cursor: pointer;
    font-family: 'Sora', sans-serif; font-size: 0.8rem; font-weight: 600; transition: all 0.2s;
  }
  .btn-primary { background: linear-gradient(135deg, var(--accent), #0099bb); color: #000; }
  .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 20px rgba(0,212,255,0.3); }
  .btn-secondary { background: var(--surface2); color: var(--text); border: 1px solid var(--border); }
  .btn-secondary:hover { border-color: var(--accent); color: var(--accent); }
  .btn-danger { background: rgba(255,59,92,0.15); color: var(--danger); border: 1px solid rgba(255,59,92,0.3); }
  .btn-danger:hover { background: rgba(255,59,92,0.25); }
  .btn-success { background: rgba(0,255,157,0.15); color: var(--accent2); border: 1px solid rgba(0,255,157,0.3); }
  .btn-success:hover { background: rgba(0,255,157,0.25); }
  .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; }

  /* ALERTA */
  #alerta-bloqueados {
    display: none; margin: 1.5rem 2rem 0;
    background: rgba(255,59,92,0.1); border: 1px solid rgba(255,59,92,0.4);
    border-radius: var(--card-radius); padding: 1rem 1.5rem;
    animation: pulse-border 2s infinite;
  }
  @keyframes pulse-border { 0%,100%{border-color:rgba(255,59,92,0.4)} 50%{border-color:rgba(255,59,92,0.9);box-shadow:0 0 20px rgba(255,59,92,0.2)} }
  .alerta-title { font-size: 0.85rem; font-weight: 700; color: var(--danger); margin-bottom: 6px; }
  .alerta-lista { font-size: 0.8rem; color: #ff8099; line-height: 1.8; }

  /* MAIN */
  main { position: relative; z-index: 1; padding: 1.5rem 2rem 3rem; max-width: 1600px; margin: 0 auto; }
  .tab-content { display: none; }
  .tab-content.active { display: block; }

  /* STATS */
  .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
  .stat-card {
    background: var(--surface); border: 1px solid var(--border); border-radius: var(--card-radius);
    padding: 1.25rem 1.5rem; position: relative; overflow: hidden; transition: transform 0.2s;
  }
  .stat-card:hover { transform: translateY(-2px); }
  .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: var(--accent-color, var(--accent)); }
  .stat-label { font-size: 0.72rem; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
  .stat-value { font-size: 1.8rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: var(--accent-color, var(--accent)); }
  .stat-sub { font-size: 0.75rem; color: var(--muted); margin-top: 4px; }

  /* FILTROS */
  .filters { display: flex; gap: 12px; margin-bottom: 1.5rem; flex-wrap: wrap; align-items: flex-end; }
  .filter-group { display: flex; flex-direction: column; gap: 4px; }
  .filter-label { font-size: 0.68rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.8px; }
  select, input[type="text"], input[type="number"] {
    background: var(--surface); border: 1px solid var(--border); color: var(--text);
    padding: 8px 12px; border-radius: 8px; font-family: 'Sora', sans-serif;
    font-size: 0.82rem; outline: none; transition: border-color 0.2s; min-width: 140px;
  }
  select:focus, input:focus { border-color: var(--accent); }

  /* LAYOUT */
  .main-grid { display: grid; grid-template-columns: 1fr 360px; gap: 1.5rem; align-items: start; }
  @media (max-width: 1100px) { .main-grid { grid-template-columns: 1fr; } }

  /* TABELA */
  .table-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--card-radius); overflow: hidden; }
  .table-header { padding: 1rem 1.5rem; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
  .table-title { font-size: 0.9rem; font-weight: 700; }
  .table-count { font-size: 0.75rem; color: var(--muted); font-family: 'JetBrains Mono', monospace; }
  .table-wrap { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; }
  thead th { padding: 10px 14px; text-align: left; font-size: 0.68rem; text-transform: uppercase; letter-spacing: 0.8px; color: var(--muted); background: var(--surface2); border-bottom: 1px solid var(--border); white-space: nowrap; }
  tbody tr { border-bottom: 1px solid rgba(30,45,69,0.5); transition: background 0.15s; }
  tbody tr:hover { background: rgba(0,212,255,0.04); }
  tbody tr.bloqueado { background: rgba(255,59,92,0.05); }
  td { padding: 10px 14px; font-size: 0.82rem; white-space: nowrap; }
  .td-paciente { max-width: 240px; overflow: hidden; text-overflow: ellipsis; }
  .td-valor { font-family: 'JetBrains Mono', monospace; font-weight: 600; color: var(--accent2); }
  .td-nf { font-family: 'JetBrains Mono', monospace; font-size: 0.72rem; color: var(--muted); }
  .badge-cidade { display: inline-block; padding: 2px 8px; border-radius: 20px; font-size: 0.68rem; font-weight: 600; text-transform: uppercase; }
  .badge-doutor { display: inline-block; padding: 2px 10px; border-radius: 20px; font-size: 0.72rem; font-weight: 600; background: rgba(0,212,255,0.1); color: var(--accent); border: 1px solid rgba(0,212,255,0.2); }
  .badge-bloqueado { display: inline-block; padding: 2px 8px; border-radius: 20px; font-size: 0.68rem; font-weight: 600; background: rgba(255,59,92,0.15); color: var(--danger); border: 1px solid rgba(255,59,92,0.3); animation: blink 1.5s infinite; }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.4} }
  .tr-cidade-total td { background: var(--surface2); font-weight: 700; font-size: 0.78rem; color: var(--accent); border-top: 1px solid var(--border); }

  /* SIDEBAR DOUTORES */
  .sidebar { display: flex; flex-direction: column; gap: 1rem; }
  .section-title { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--muted); margin-bottom: 0.75rem; }
  .doutor-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 1rem 1.2rem; transition: all 0.2s; cursor: pointer; }
  .doutor-card:hover { border-color: var(--accent); transform: translateX(2px); }
  .doutor-card.bloqueado { border-color: rgba(255,59,92,0.5); background: rgba(255,59,92,0.05); animation: pulse-card 2s infinite; }
  @keyframes pulse-card { 0%,100%{box-shadow:none} 50%{box-shadow:0 0 15px rgba(255,59,92,0.2)} }
  .doutor-nome { font-size: 0.85rem; font-weight: 700; }
  .doutor-pix { font-size: 0.68rem; color: var(--muted); font-family: 'JetBrains Mono', monospace; margin-top: 2px; }
  .progress-bar { height: 6px; background: var(--surface2); border-radius: 3px; overflow: hidden; margin-top: 8px; }
  .progress-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; background: linear-gradient(90deg, var(--accent2), var(--accent)); }
  .progress-fill.danger { background: linear-gradient(90deg, #ff3b5c, #ff6b80); }
  .progress-fill.warning { background: linear-gradient(90deg, var(--warning), #ffd080); }
  .doutor-valores { display: flex; justify-content: space-between; margin-top: 6px; font-size: 0.72rem; font-family: 'JetBrains Mono', monospace; }
  .val-usado { color: var(--accent2); }
  .val-saldo.danger { color: var(--danger); font-weight: 700; }
  .val-saldo.warning { color: var(--warning); font-weight: 700; }
  .val-saldo.ok { color: var(--muted); }

  /* CIDADES */
  .cidades-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 0.75rem; margin-bottom: 1.5rem; }
  .cidade-card { background: var(--surface); border: 1px solid var(--border); border-radius: 12px; padding: 0.9rem 1rem; cursor: pointer; transition: all 0.2s; }
  .cidade-card:hover, .cidade-card.active { border-color: var(--accent); background: rgba(0,212,255,0.05); }
  .cidade-nome { font-size: 0.8rem; font-weight: 700; margin-bottom: 4px; }
  .cidade-total { font-size: 1.1rem; font-weight: 700; font-family: 'JetBrains Mono', monospace; color: var(--accent2); }
  .cidade-count { font-size: 0.7rem; color: var(--muted); }

  /* LOADING */
  #loading { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 4rem; gap: 1rem; }
  .spinner { width: 40px; height: 40px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .empty-state { text-align: center; padding: 3rem; color: var(--muted); font-size: 0.85rem; }

  /* ADMIN */
  .admin-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1.5rem; }
  .admin-title { font-size: 1.1rem; font-weight: 700; }
  .admin-table-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--card-radius); overflow: hidden; }
  .admin-table { width: 100%; border-collapse: collapse; }
  .admin-table thead th { padding: 10px 14px; text-align: left; font-size: 0.68rem; text-transform: uppercase; letter-spacing: 0.8px; color: var(--muted); background: var(--surface2); border-bottom: 1px solid var(--border); }
  .admin-table tbody tr { border-bottom: 1px solid rgba(30,45,69,0.4); }
  .admin-table tbody tr:hover { background: rgba(0,212,255,0.03); }
  .admin-table td { padding: 8px 10px; }
  .admin-input {
    background: transparent; border: 1px solid transparent; color: var(--text);
    padding: 5px 8px; border-radius: 6px; font-family: 'Sora', sans-serif;
    font-size: 0.8rem; width: 100%; transition: all 0.2s; min-width: 0;
  }
  .admin-input:focus { background: var(--surface2); border-color: var(--accent); outline: none; }
  .admin-input.limite { font-family: 'JetBrains Mono', monospace; width: 90px; }
  .bloqueado-toggle {
    display: flex; align-items: center; gap: 6px; cursor: pointer;
    font-size: 0.75rem; padding: 4px 10px; border-radius: 6px; border: none;
    font-family: 'Sora', sans-serif; font-weight: 600; transition: all 0.2s;
  }
  .bloqueado-toggle.sim { background: rgba(255,59,92,0.15); color: var(--danger); border: 1px solid rgba(255,59,92,0.3); }
  .bloqueado-toggle.nao { background: rgba(0,255,157,0.1); color: var(--accent2); border: 1px solid rgba(0,255,157,0.2); }
  .add-doutor-form {
    background: var(--surface2); border: 1px dashed var(--border); border-radius: var(--card-radius);
    padding: 1.5rem; margin-top: 1.5rem; display: grid;
    grid-template-columns: 2fr 2fr 1fr auto; gap: 12px; align-items: end;
  }
  .form-group { display: flex; flex-direction: column; gap: 6px; }
  .form-label { font-size: 0.68rem; color: var(--muted); text-transform: uppercase; letter-spacing: 0.8px; }
  .form-input {
    background: var(--surface); border: 1px solid var(--border); color: var(--text);
    padding: 8px 12px; border-radius: 8px; font-family: 'Sora', sans-serif; font-size: 0.82rem; outline: none;
  }
  .form-input:focus { border-color: var(--accent); }
  .save-notice { font-size: 0.72rem; color: var(--accent2); margin-top: 1rem; display: none; }

  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
</style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-icon">ü¶∑</div>
    <div>
      <div class="logo-text">Top Est√©tica Bucal</div>
      <div class="logo-sub">PIX Doutores ‚Äî Dashboard</div>
    </div>
  </div>
  <div class="header-right">
    <span id="last-update">Carregando...</span>
    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab('dashboard')">üìä Dashboard</button>
      <button class="tab-btn" onclick="switchTab('admin')">‚öôÔ∏è Admin</button>
    </div>
    <button class="btn btn-secondary" onclick="carregarDados()" id="btn-atualizar">üîÑ Atualizar</button>
    <button class="btn btn-primary" onclick="exportarExcel()">üì• Excel</button>
  </div>
</header>

<div id="alerta-bloqueados">
  <div class="alerta-title">üö´ ATEN√á√ÉO ‚Äî N√ÉO REPASSAR PIX PARA:</div>
  <div class="alerta-lista" id="lista-bloqueados"></div>
</div>

<main>
  <!-- LOADING -->
  <div id="loading">
    <div class="spinner"></div>
    <span style="color:var(--muted);font-size:0.85rem">Buscando dados dos sistemas...</span>
  </div>

  <!-- DASHBOARD TAB -->
  <div id="tab-dashboard" class="tab-content active" style="display:none">
    <div class="stats-grid" id="stats-grid"></div>

    <div class="section-title" style="margin-bottom:0.75rem">üìç Por Cidade ‚Äî clique para filtrar</div>
    <div class="cidades-grid" id="cidades-grid"></div>

    <div class="filters">
      <div class="filter-group">
        <span class="filter-label">Cidade</span>
        <select id="filtro-cidade" onchange="aplicarFiltros()">
          <option value="">Todas</option>
        </select>
      </div>
      <div class="filter-group">
        <span class="filter-label">Doutor(a)</span>
        <select id="filtro-doutor" onchange="aplicarFiltros()">
          <option value="">Todos</option>
        </select>
      </div>
      <div class="filter-group">
        <span class="filter-label">Buscar paciente</span>
        <input type="text" id="filtro-busca" placeholder="Nome..." oninput="aplicarFiltros()">
      </div>
      <div class="filter-group">
        <span class="filter-label">Status</span>
        <select id="filtro-status" onchange="aplicarFiltros()">
          <option value="">Todos</option>
          <option value="bloqueado">üö´ Bloqueados</option>
          <option value="ok">‚úÖ Ativos</option>
        </select>
      </div>
      <button class="btn btn-secondary" onclick="limparFiltros()" style="height:36px">‚úï Limpar</button>
    </div>

    <div class="main-grid">
      <div class="table-card">
        <div class="table-header">
          <span class="table-title">Lan√ßamentos PIX Doutores</span>
          <span class="table-count" id="table-count"></span>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Data</th><th>Cidade</th><th>Paciente</th><th>Pago por</th>
                <th>Doutor(a)</th><th>Valor</th><th>Chave PIX (NF)</th>
              </tr>
            </thead>
            <tbody id="tabela-body"></tbody>
          </table>
        </div>
      </div>

      <div class="sidebar">
        <div>
          <div class="section-title">üë®‚Äç‚öïÔ∏è Doutores ‚Äî Saldo dispon√≠vel</div>
          <div id="doutores-lista"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ADMIN TAB -->
  <div id="tab-admin" class="tab-content">
    <div class="admin-header">
      <div class="admin-title">‚öôÔ∏è Gerenciar Doutores</div>
      <div style="display:flex;gap:10px">
        <button class="btn btn-success" onclick="salvarDoutores()">üíæ Salvar altera√ß√µes</button>
        <button class="btn btn-secondary" onclick="resetarDoutores()">‚Ü© Restaurar padr√£o</button>
      </div>
    </div>
    <p style="font-size:0.8rem;color:var(--muted);margin-bottom:1.5rem">
      Edite os campos diretamente na tabela. Clique em üíæ Salvar para aplicar as mudan√ßas.
      Os dados ficam salvos no navegador automaticamente.
    </p>

    <div class="admin-table-card">
      <table class="admin-table">
        <thead>
          <tr>
            <th style="width:30px">#</th>
            <th>Nome do Doutor(a)</th>
            <th>Chave PIX</th>
            <th>Limite R$</th>
            <th>Status</th>
            <th>A√ß√£o</th>
          </tr>
        </thead>
        <tbody id="admin-tbody"></tbody>
      </table>
    </div>

    <div class="add-doutor-form">
      <div class="form-group">
        <label class="form-label">Nome</label>
        <input type="text" class="form-input" id="novo-nome" placeholder="Nome completo">
      </div>
      <div class="form-group">
        <label class="form-label">Chave PIX</label>
        <input type="text" class="form-input" id="novo-pix" placeholder="CPF, telefone ou e-mail">
      </div>
      <div class="form-group">
        <label class="form-label">Limite R$</label>
        <input type="number" class="form-input" id="novo-limite" placeholder="2000" min="0" step="0.01">
      </div>
      <button class="btn btn-primary" onclick="adicionarDoutor()" style="height:38px">+ Adicionar</button>
    </div>

    <div class="save-notice" id="save-notice">‚úÖ Altera√ß√µes salvas com sucesso!</div>
  </div>
</main>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
// ===================== DADOS PADR√ÉO DOS DOUTORES =====================
const DOUTORES_PADRAO = [
  {nome:"Adriele da Silva",pix:"",limite:3000,bloqueado:false},
  {nome:"Alan Sechin",pix:"",limite:0,bloqueado:true},
  {nome:"Alexandre Favero",pix:"54997111727",limite:1500,bloqueado:false},
  {nome:"Ana Cristina Corso",pix:"54991612540",limite:1500,bloqueado:false},
  {nome:"Bruno Castellan",pix:"2086873000",limite:400,bloqueado:false},
  {nome:"Bruno Lorenzoni",pix:"51991429288",limite:2000,bloqueado:false},
  {nome:"Cristian Pressi",pix:"63152309000117",limite:5000,bloqueado:false},
  {nome:"Diogo Amarante Cemim",pix:"54991831951",limite:100,bloqueado:false},
  {nome:"Dionathan Pohlmann",pix:"dionathanph@gmail.com",limite:6000,bloqueado:false},
  {nome:"Emerson Rhoden",pix:"54981469051",limite:0,bloqueado:true},
  {nome:"Evalda Baldissera",pix:"54984188934",limite:6170,bloqueado:false},
  {nome:"Everlize Cipriani",pix:"010.451.100-19",limite:2000,bloqueado:false},
  {nome:"Fernanda Sozo",pix:"54999842330",limite:1500,bloqueado:false},
  {nome:"Franciele Pedrotti",pix:"58851477000160",limite:10000,bloqueado:false},
  {nome:"Gabrielli Fabonato",pix:"54991698645",limite:4000,bloqueado:false},
  {nome:"Giovana Gasparini",pix:"54996822082",limite:2000,bloqueado:false},
  {nome:"Gislaine Santos",pix:"38297797805",limite:1000,bloqueado:false},
  {nome:"Greici Matiello",pix:"54991893311",limite:500,bloqueado:false},
  {nome:"Gustavo Louren√ßo Ongaratto",pix:"3372256050",limite:100,bloqueado:false},
  {nome:"Indiamara Rech",pix:"",limite:0,bloqueado:true},
  {nome:"Jennifer Dotti",pix:"3691532004",limite:1000,bloqueado:false},
  {nome:"J√©ssica Barreto",pix:"039.932.200.05",limite:1000,bloqueado:false},
  {nome:"Joana Sganzerla",pix:"938217003",limite:500,bloqueado:false},
  {nome:"Juana Billig",pix:"juana.billig@gmail.com",limite:3500,bloqueado:false},
  {nome:"Laura Luiza Cimolin",pix:"lauraluizacimolin@gmail.com",limite:2000,bloqueado:false},
  {nome:"Leandro Diniz",pix:"14568995701",limite:1000,bloqueado:false},
  {nome:"Leticia Canabarro",pix:"54992342002",limite:3100,bloqueado:false},
  {nome:"Let√≠cia Cauzzi",pix:"dentistaleticiacr@gmail.com",limite:4000,bloqueado:false},
  {nome:"Luiz Henrique",pix:"98788396053",limite:1100,bloqueado:false},
  {nome:"Marcella Zancanaro",pix:"4952333078",limite:1200,bloqueado:false},
  {nome:"Matheus Strapasson",pix:"02598169069",limite:1000,bloqueado:false},
  {nome:"Morgana Zambiasi",pix:"zambiasimorgana@gmail.com",limite:1500,bloqueado:false},
  {nome:"Murilo Debortoli",pix:"4507008018",limite:1000,bloqueado:false},
  {nome:"Naiane Pieta",pix:"025.209.120.57",limite:1000,bloqueado:false},
  {nome:"Nelson Vaccari",pix:"54999174994",limite:4000,bloqueado:false},
  {nome:"Nicoli Weber",pix:"05371943129",limite:1200,bloqueado:false},
  {nome:"Rodrigo Silveira",pix:"51982940785",limite:1500,bloqueado:false},
  {nome:"Sara Trevisol",pix:"03635558036",limite:1850,bloqueado:false},
  {nome:"Sofie Owens",pix:"sofie.owens@hotmail.com",limite:3500,bloqueado:false},
  {nome:"Tamara Macanan",pix:"54996448434",limite:8000,bloqueado:false},
  {nome:"Thalia Tessaro",pix:"5a64e276-f01a-4340-9837-68a8b20eeb74",limite:3000,bloqueado:false},
  {nome:"Thalia Vezzosi",pix:"thaliavezzosi@rede.ulbra.br",limite:2500,bloqueado:false},
  {nome:"Thiany Cristofoli",pix:"54996177112",limite:4000,bloqueado:false},
];

// ===================== ESTADO =====================
let DOUTORES = carregarDoutores();
let PIX_MAP = {};
let todosRegistros = [];
let registrosFiltrados = [];

function carregarDoutores() {
  try {
    const saved = localStorage.getItem('top_doutores');
    if (saved) return JSON.parse(saved);
  } catch(e) {}
  return JSON.parse(JSON.stringify(DOUTORES_PADRAO));
}

function salvarDoutoresLocal(lista) {
  try { localStorage.setItem('top_doutores', JSON.stringify(lista)); } catch(e) {}
}

function reconstruirPixMap() {
  PIX_MAP = {};
  DOUTORES.forEach(d => { if (d.pix) PIX_MAP[d.pix.trim()] = d; });
}
reconstruirPixMap();

// ===================== TABS =====================
function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach((b,i) => b.classList.toggle('active', ['dashboard','admin'][i] === tab));
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.getElementById('tab-' + tab).classList.add('active');
  if (tab === 'admin') renderAdmin();
}

// ===================== CORES =====================
const CIDADE_CORES = {
  "CAXIAS":"#00d4ff","FARROUPILHA":"#00ff9d","BENTO":"#a78bfa",
  "ENCANTADO":"#fb923c","SOLEDADE":"#f472b6","GARIBALDI":"#facc15",
  "VERANOPOLIS":"#34d399","SS DO CAI":"#60a5fa","FLORES":"#f87171"
};
function corCidade(c) { return CIDADE_CORES[c?.toUpperCase()] || "#6b7fa3"; }

// ===================== CARREGAR DADOS =====================
const DATA_URL = "https://raw.githubusercontent.com/Top-Desenvolvimento/top-estetica/main/dados.json";

async function carregarDados() {
  document.getElementById("loading").style.display = "flex";
  document.getElementById("tab-dashboard").style.display = "none";
  document.getElementById("btn-atualizar").disabled = true;

  try {
    const res = await fetch(DATA_URL + "?t=" + Date.now());
    if (!res.ok) throw new Error("HTTP " + res.status);
    const json = await res.json();

    todosRegistros = (json.dados || []).map(r => {
      const nf = (r.nf || "").trim();
      const doutor = nf ? (PIX_MAP[nf] || null) : null;
      return {
        ...r,
        doutor_nome: doutor ? doutor.nome : null,
        doutor_bloqueado: doutor ? (doutor.bloqueado || doutor.limite === 0) : false,
        tem_nf: !!nf
      };
    });

    const gerado = json.gerado_em ? new Date(json.gerado_em).toLocaleString("pt-BR") : "‚Äî";
    document.getElementById("last-update").textContent = "Atualizado: " + gerado;

    renderizarTudo();
    document.getElementById("loading").style.display = "none";
    document.getElementById("tab-dashboard").style.display = "block";
    document.getElementById("tab-dashboard").classList.add("active");

  } catch(e) {
    document.getElementById("loading").innerHTML = `
      <div style="text-align:center;color:var(--danger)">
        <div style="font-size:2rem;margin-bottom:1rem">‚ö†Ô∏è</div>
        <div style="font-weight:700;margin-bottom:0.5rem">Erro ao carregar dados</div>
        <div style="font-size:0.8rem;color:var(--muted);margin-bottom:1.5rem">${e.message}</div>
        <button class="btn btn-primary" onclick="carregarDados()">Tentar novamente</button>
      </div>`;
  }
  document.getElementById("btn-atualizar").disabled = false;
}

// ===================== RENDER =====================
function renderizarTudo() {
  registrosFiltrados = [...todosRegistros];
  renderStats();
  renderCidades();
  renderFiltros();
  renderTabela();
  renderDoutores();
  renderAlertas();
}

function renderStats() {
  const total = todosRegistros.reduce((s,r) => s + (r.valor||0), 0);
  const comDoutor = todosRegistros.filter(r => r.doutor_nome);
  const totalDoutor = comDoutor.reduce((s,r) => s + (r.valor||0), 0);
  const bloqueados = DOUTORES.filter(d => d.bloqueado || d.limite === 0).length;
  const cidades = [...new Set(todosRegistros.map(r => r.cidade))].length;

  document.getElementById("stats-grid").innerHTML = `
    <div class="stat-card" style="--accent-color:#00d4ff">
      <div class="stat-label">Total PIX Doutores</div>
      <div class="stat-value">R$ ${total.toLocaleString("pt-BR",{minimumFractionDigits:2})}</div>
      <div class="stat-sub">${todosRegistros.length} registros no m√™s</div>
    </div>
    <div class="stat-card" style="--accent-color:#00ff9d">
      <div class="stat-label">Vinculado a Doutor</div>
      <div class="stat-value">R$ ${totalDoutor.toLocaleString("pt-BR",{minimumFractionDigits:2})}</div>
      <div class="stat-sub">${comDoutor.length} com chave PIX identificada</div>
    </div>
    <div class="stat-card" style="--accent-color:#ffb547">
      <div class="stat-label">Cidades Ativas</div>
      <div class="stat-value">${cidades}</div>
      <div class="stat-sub">de 9 unidades</div>
    </div>
    <div class="stat-card" style="--accent-color:#ff3b5c">
      <div class="stat-label">Doutores Bloqueados</div>
      <div class="stat-value">${bloqueados}</div>
      <div class="stat-sub">PIX n√£o autorizado</div>
    </div>`;
}

function renderCidades() {
  const cidades = {};
  todosRegistros.forEach(r => {
    const c = r.cidade || "SEM CIDADE";
    if (!cidades[c]) cidades[c] = {total:0, count:0};
    cidades[c].total += r.valor||0;
    cidades[c].count++;
  });

  const sel = document.getElementById("filtro-cidade");
  const cur = sel.value;
  sel.innerHTML = '<option value="">Todas</option>';
  Object.keys(cidades).sort().forEach(c => sel.innerHTML += `<option value="${c}">${c}</option>`);
  sel.value = cur;

  document.getElementById("cidades-grid").innerHTML = Object.entries(cidades)
    .sort((a,b) => b[1].total - a[1].total)
    .map(([c,d]) => `
      <div class="cidade-card" onclick="filtrarCidade(this,'${c}')" style="border-top:3px solid ${corCidade(c)}">
        <div class="cidade-nome">${c}</div>
        <div class="cidade-total">R$ ${d.total.toLocaleString("pt-BR",{minimumFractionDigits:2})}</div>
        <div class="cidade-count">${d.count} lan√ßamentos</div>
      </div>`).join("");
}

function renderFiltros() {
  const doutores = [...new Set(todosRegistros.filter(r=>r.doutor_nome).map(r=>r.doutor_nome))].sort();
  const sel = document.getElementById("filtro-doutor");
  const cur = sel.value;
  sel.innerHTML = '<option value="">Todos</option>';
  doutores.forEach(d => sel.innerHTML += `<option value="${d}">${d}</option>`);
  sel.value = cur;
}

function filtrarCidade(el, c) {
  document.getElementById("filtro-cidade").value = c;
  document.querySelectorAll(".cidade-card").forEach(e => e.classList.remove("active"));
  el.classList.add("active");
  aplicarFiltros();
}

function aplicarFiltros() {
  const cidade = document.getElementById("filtro-cidade").value;
  const doutor = document.getElementById("filtro-doutor").value;
  const busca  = document.getElementById("filtro-busca").value.toLowerCase();
  const status = document.getElementById("filtro-status").value;

  registrosFiltrados = todosRegistros.filter(r => {
    if (cidade && r.cidade !== cidade) return false;
    if (doutor && r.doutor_nome !== doutor) return false;
    if (busca  && !(r.paciente||"").toLowerCase().includes(busca)) return false;
    if (status === "bloqueado" && !r.doutor_bloqueado) return false;
    if (status === "ok" && r.doutor_bloqueado) return false;
    return true;
  });
  renderTabela();
}

function limparFiltros() {
  ["filtro-cidade","filtro-doutor","filtro-status"].forEach(id => document.getElementById(id).value = "");
  document.getElementById("filtro-busca").value = "";
  document.querySelectorAll(".cidade-card").forEach(e => e.classList.remove("active"));
  registrosFiltrados = [...todosRegistros];
  renderTabela();
}

function renderTabela() {
  document.getElementById("table-count").textContent = `${registrosFiltrados.length} registros`;

  if (!registrosFiltrados.length) {
    document.getElementById("tabela-body").innerHTML = `<tr><td colspan="7" class="empty-state">Nenhum registro encontrado</td></tr>`;
    return;
  }

  const porCidade = {};
  registrosFiltrados.forEach(r => {
    const c = r.cidade||"SEM CIDADE";
    if (!porCidade[c]) porCidade[c] = [];
    porCidade[c].push(r);
  });

  let html = "";
  Object.entries(porCidade).sort().forEach(([cidade, regs]) => {
    regs.forEach(r => {
      const cor = corCidade(r.cidade);
      html += `<tr class="${r.doutor_bloqueado?'bloqueado':''}">
        <td>${r.data||""}</td>
        <td><span class="badge-cidade" style="background:${cor}22;color:${cor};border:1px solid ${cor}44">${r.cidade||""}</span></td>
        <td class="td-paciente" title="${r.paciente||""}">${r.paciente||""}</td>
        <td style="font-size:0.75rem;color:var(--muted)">${r.responsavel||""}</td>
        <td>${r.doutor_nome
          ? (r.doutor_bloqueado
            ? `<span class="badge-bloqueado">üö´ ${r.doutor_nome}</span>`
            : `<span class="badge-doutor">${r.doutor_nome}</span>`)
          : '<span style="color:var(--muted);font-size:0.75rem">‚Äî</span>'}</td>
        <td class="td-valor">R$ ${(r.valor||0).toLocaleString("pt-BR",{minimumFractionDigits:2})}</td>
        <td class="td-nf">${r.nf||"‚Äî"}</td>
      </tr>`;
    });
    const sub = regs.reduce((s,r)=>s+(r.valor||0),0);
    html += `<tr class="tr-cidade-total">
      <td colspan="5" style="padding-left:1.5rem">Subtotal ${cidade}</td>
      <td>R$ ${sub.toLocaleString("pt-BR",{minimumFractionDigits:2})}</td><td></td>
    </tr>`;
  });

  document.getElementById("tabela-body").innerHTML = html;
}

function renderDoutores() {
  const usado = {};
  todosRegistros.forEach(r => {
    if (r.doutor_nome) usado[r.doutor_nome] = (usado[r.doutor_nome]||0) + (r.valor||0);
  });

  const html = DOUTORES
    .slice()
    .sort((a,b) => a.nome.localeCompare(b.nome, 'pt-BR'))
    .map(d => {
      const usadoVal = usado[d.nome] || 0;
      const saldo = d.limite - usadoVal;
      const pct = d.limite > 0 ? Math.min((usadoVal/d.limite)*100, 100) : 100;
      const bloq = d.bloqueado || d.limite === 0 || saldo <= 0;
      const saldoCls = saldo < 0 ? "danger" : saldo < d.limite*0.3 ? "warning" : "ok";
      const fillCls = saldo <= 0 ? "danger" : saldo < d.limite*0.3 ? "warning" : "";

      return `<div class="doutor-card ${bloq?'bloqueado':''}" onclick="filtrarDoutor('${d.nome}')">
        <div class="doutor-nome">${bloq?"üö´ ":""}${d.nome}</div>
        ${d.pix ? `<div class="doutor-pix">${d.pix}</div>` : ''}
        ${d.limite > 0 ? `
          <div class="progress-bar"><div class="progress-fill ${fillCls}" style="width:${pct}%"></div></div>
          <div class="doutor-valores">
            <span class="val-usado">Usado: R$ ${usadoVal.toLocaleString("pt-BR",{minimumFractionDigits:2})}</span>
            <span class="val-saldo ${saldoCls}">Saldo: R$ ${saldo.toLocaleString("pt-BR",{minimumFractionDigits:2})}</span>
          </div>` 
        : `<div style="font-size:0.72rem;color:var(--danger);margin-top:6px">‚õî PIX bloqueado ‚Äî limite zerado</div>`}
      </div>`;
    }).join("");

  document.getElementById("doutores-lista").innerHTML = html || '<div class="empty-state">Nenhum doutor cadastrado</div>';
}

function filtrarDoutor(nome) {
  switchTab('dashboard');
  document.getElementById("filtro-doutor").value = nome;
  aplicarFiltros();
}

function renderAlertas() {
  const usado = {};
  todosRegistros.forEach(r => { if(r.doutor_nome) usado[r.doutor_nome]=(usado[r.doutor_nome]||0)+(r.valor||0); });
  const bloq = DOUTORES.filter(d => d.bloqueado || d.limite===0 || (d.limite>0 && (usado[d.nome]||0)>=d.limite));
  if (!bloq.length) { document.getElementById("alerta-bloqueados").style.display="none"; return; }
  document.getElementById("alerta-bloqueados").style.display="block";
  document.getElementById("lista-bloqueados").innerHTML = bloq
    .map(d => `üö´ ${d.nome} ‚Äî ${d.bloqueado||d.limite===0 ? "PIX n√£o autorizado" : "Cr√©dito esgotado"}`).join("<br>");
}

// ===================== ADMIN =====================
function renderAdmin() {
  const tbody = document.getElementById("admin-tbody");
  tbody.innerHTML = DOUTORES
    .map((d,i) => `
      <tr>
        <td style="color:var(--muted);font-size:0.72rem">${i+1}</td>
        <td><input class="admin-input" value="${d.nome}" onchange="atualizarDoutor(${i},'nome',this.value)" style="min-width:200px"></td>
        <td><input class="admin-input" value="${d.pix||''}" onchange="atualizarDoutor(${i},'pix',this.value)" style="min-width:180px;font-family:'JetBrains Mono',monospace;font-size:0.75rem"></td>
        <td><input class="admin-input limite" type="number" value="${d.limite}" min="0" onchange="atualizarDoutor(${i},'limite',parseFloat(this.value)||0)"></td>
        <td>
          <button class="bloqueado-toggle ${d.bloqueado||d.limite===0?'sim':'nao'}" onclick="toggleBloqueado(${i})">
            ${d.bloqueado||d.limite===0 ? 'üö´ Bloqueado' : '‚úÖ Ativo'}
          </button>
        </td>
        <td><button class="btn btn-danger" style="padding:4px 10px;font-size:0.75rem" onclick="removerDoutor(${i})">üóë</button></td>
      </tr>`).join("");
}

function atualizarDoutor(i, campo, valor) {
  DOUTORES[i][campo] = valor;
}

function toggleBloqueado(i) {
  DOUTORES[i].bloqueado = !DOUTORES[i].bloqueado;
  renderAdmin();
}

function removerDoutor(i) {
  if (!confirm(`Remover "${DOUTORES[i].nome}"?`)) return;
  DOUTORES.splice(i, 1);
  renderAdmin();
}

function adicionarDoutor() {
  const nome  = document.getElementById("novo-nome").value.trim();
  const pix   = document.getElementById("novo-pix").value.trim();
  const limite = parseFloat(document.getElementById("novo-limite").value) || 0;
  if (!nome) { alert("Informe o nome do doutor"); return; }

  DOUTORES.push({nome, pix, limite, bloqueado: false});
  DOUTORES.sort((a,b) => a.nome.localeCompare(b.nome,'pt-BR'));

  document.getElementById("novo-nome").value = "";
  document.getElementById("novo-pix").value = "";
  document.getElementById("novo-limite").value = "";
  renderAdmin();
}

function salvarDoutores() {
  // Ordenar A-Z antes de salvar
  DOUTORES.sort((a,b) => a.nome.localeCompare(b.nome,'pt-BR'));
  salvarDoutoresLocal(DOUTORES);
  reconstruirPixMap();

  // Re-enriquecer registros com novo mapa
  todosRegistros = todosRegistros.map(r => {
    const nf = (r.nf||"").trim();
    const doutor = nf ? (PIX_MAP[nf]||null) : null;
    return {...r, doutor_nome: doutor?doutor.nome:null, doutor_bloqueado: doutor?(doutor.bloqueado||doutor.limite===0):false};
  });

  renderAdmin();
  renderizarTudo();

  const notice = document.getElementById("save-notice");
  notice.style.display = "block";
  setTimeout(() => notice.style.display = "none", 3000);
}

function resetarDoutores() {
  if (!confirm("Restaurar lista padr√£o de doutores? Suas edi√ß√µes ser√£o perdidas.")) return;
  DOUTORES = JSON.parse(JSON.stringify(DOUTORES_PADRAO));
  salvarDoutoresLocal(DOUTORES);
  reconstruirPixMap();
  renderAdmin();
  renderizarTudo();
}

// ===================== EXPORTAR =====================
function exportarExcel() {
  const wb = XLSX.utils.book_new();
  const lancData = [
    ["Data","Cidade","Paciente","Pago por","Doutor(a)","Chave PIX","Valor","Status"],
    ...todosRegistros.map(r => [r.data,r.cidade,r.paciente,r.responsavel,r.doutor_nome||"‚Äî",r.nf||"",r.valor||0,r.doutor_bloqueado?"BLOQUEADO":"OK"])
  ];
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(lancData), "Lan√ßamentos");

  const cidades = {};
  todosRegistros.forEach(r => { const c=r.cidade||"SEM CIDADE"; cidades[c]=(cidades[c]||0)+(r.valor||0); });
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet([["Cidade","Total"],...Object.entries(cidades).sort()]), "Por Cidade");

  const usado = {};
  todosRegistros.forEach(r => { if(r.doutor_nome) usado[r.doutor_nome]=(usado[r.doutor_nome]||0)+(r.valor||0); });
  const drData = [["Doutor(a)","Chave PIX","Limite","Usado","Saldo","Status"],
    ...DOUTORES.map(d => { const u=usado[d.nome]||0; const s=d.limite-u; return [d.nome,d.pix,d.limite,u,s,d.bloqueado||d.limite===0?"BLOQUEADO":s<=0?"ESGOTADO":s<d.limite*0.3?"ATEN√á√ÉO":"OK"]; })];
  XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(drData), "Por Doutor");

  XLSX.writeFile(wb, `TopEstetica_PIX_${new Date().toISOString().slice(0,7)}.xlsx`);
}

// ===================== INIT =====================
carregarDados();
setInterval(carregarDados, 30 * 60 * 1000);
</script>
</body>
</html>
